<!DOCTYPE html>
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>hapi - API</title>

    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/overrides.css">

    <script src="/js/vendor/html5shiv.js"></script>
</head>
<body>

<header class="header" role="banner">
    <div class="l-constrained">
        <h1 class="logo logo-small">
            <a title="Return to Home" href="/">
                <img width="150" height="104" src="/img/logo-small.png" alt="hapi">
            </a>
        </h1>
    </div>
</header>

<section role="main">
    <div class="l-constrained">
        <div class="l-row"><div class="l-col1 sidebar"><ul>
<li>
<a href="#toc_0">Server Construction</a>
</li>
<li>
<a href="#toc_1">Server Configuration</a>
<ul>
<li>
<a href="#toc_2">TLS</a>
</li>
<li>
<a href="#toc_3">Router</a>
</li>
<li>
<a href="#toc_4">Payload</a>
</li>
<li>
<a href="#toc_5">Extensions</a>
</li>
<li>
<a href="#toc_6">Static Files</a>
</li>
<li>
<a href="#toc_7">Views</a>
</li>
<li>
<a href="#toc_8">Authentication</a>
<ul>
<li>
<a href="#toc_9">Basic Authentication</a>
</li>
<li>
<a href="#toc_10">Cookie Authentication</a>
</li>
<li>
<a href="#toc_11">Hawk Authentication</a>
</li>
<li>
<a href="#toc_12">Hawk Bewit Authentication</a>
</li>
</ul>
</li>
<li>
<a href="#toc_13">Cache</a>
</li>
<li>
<a href="#toc_14">CORS</a>
</li>
<li>
<a href="#toc_15">State</a>
</li>
<li>
<a href="#toc_16">Timeout</a>
<ul>
<li>
<a href="#toc_17">Server Timeout</a>
</li>
<li>
<a href="#toc_18">Client Timeout</a>
</li>
<li>
<a href="#toc_19">Socket Timeout</a>
</li>
</ul>
</li>
<li>
<a href="#toc_20">Debug</a>
</li>
</ul>
</li>
<li>
<a href="#toc_21">Server Events</a>
</li>
<li>
<a href="#toc_22">Server Route Not Found</a>
</li>
<li>
<a href="#toc_23">Route Configuration</a>
<ul>
<li>
<a href="#toc_24">Configuration options</a>
</li>
<li>
<a href="#toc_25">Path Processing</a>
<ul>
<li>
<a href="#toc_26">Route Matching Order</a>
</li>
<li>
<a href="#toc_27">Parameters</a>
</li>
</ul>
</li>
<li>
<a href="#toc_28">Request Payload Parsing</a>
</li>
<li>
<a href="#toc_29">Route Handler</a>
<ul>
<li>
<a href="#toc_30">Response</a>
</li>
<li>
<a href="#toc_31">Proxy</a>
</li>
<li>
<a href="#toc_32">File</a>
</li>
<li>
<a href="#toc_33">Directory</a>
</li>
<li>
<a href="#toc_34">View</a>
</li>
<li>
<a href="#toc_35">Views Handler</a>
</li>
<li>
<a href="#toc_36">Layouts</a>
</li>
<li>
<a href="#toc_37">Partials</a>
</li>
<li>
<a href="#toc_38">Multiple Engines</a>
</li>
<li>
<a href="#toc_39">Request Logging</a>
</li>
</ul>
</li>
<li>
<a href="#toc_40">Not Found Handler</a>
</li>
<li>
<a href="#toc_41">Route Authentication</a>
</li>
<li>
<a href="#toc_42">Query Validation</a>
</li>
<li>
<a href="#toc_43">Payload Validation</a>
</li>
<li>
<a href="#toc_44">Path Validation</a>
</li>
<li>
<a href="#toc_45">Response Validation</a>
</li>
<li>
<a href="#toc_46">Caching</a>
</li>
<li>
<a href="#toc_47">Prerequisites</a>
</li>
</ul>
</li>
<li>
<a href="#toc_48">Data Validation</a>
</li>
<li>
<a href="#toc_49">Response Errors</a>
</li>
<li>
<a href="#toc_50">State Management</a>
<ul>
<li>
<a href="#toc_51">Raw Cookies</a>
</li>
</ul>
</li>
<li>
<a href="#toc_52">Server Logging</a>
</li>
<li>
<a href="#toc_53">Request Tails</a>
</li>
<li>
<a href="#toc_54">Request Injection</a>
</li>
<li>
<a href="#toc_55">Server Helpers</a>
</li>
</ul>
</li>
<li>
<a href="#toc_56">Server Plugins</a>
<ul>
<li>
<a href="#toc_57">Creating a Plugin</a>
<ul>
<li>
<a href="#toc_58">Plugin Schema</a>
</li>
<li>
<a href="#toc_59">Plugin Permissions</a>
</li>
</ul>
</li>
<li>
<a href="#toc_60">Installable Plugins</a>
<ul>
<li>
<a href="#toc_61">Batch Requests</a>
</li>
<li>
<a href="#toc_62">CSRF Protection</a>
</li>
<li>
<a href="#toc_63">Documentation Generator</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_64">The End</a>
</div><div class="l-col2"><p><strong><em>Please note that any feature left undocumented is experimental and may have breaking changes in future releases.</em></strong></p>

<h2 id="toc_0">Server Construction</h2>

<p>The <strong>hapi</strong> Server object is the core of the framework and is constructed by instantiating a new Server object with the following optional parameters:</p>

<ul>
<li><em>&#39;host&#39;</em> - optional host name. Defaults to &#39;localhost&#39;.</li>
<li><em>&#39;port&#39;</em> - optional port. Defaults to &#39;80&#39; (or &#39;443&#39; for TLS).</li>
<li><em>&#39;options&#39;</em> - optional configuration as described in <a href="#server-configuration">Server Configuration</a>.</li>
</ul>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="c1">// Create a server on localhost port 80</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">();</span>
</code></pre>
</div>

<h2 id="toc_1">Server Configuration</h2>

<p><strong>hapi</strong> provides a rich set of configuration options for each server instance.</p>

<h3 id="toc_2">TLS</h3>

<p><strong>hapi</strong> creates an HTTP server by default. To create an HTTPS server, include the <code>tls</code> object in the server configuration.
The <code>tls</code> object is passed unchanged to the node.js HTTPS server and described in the
<a href="http://nodejs.org/api/https.html#https_https_createserver_options_requestlistener">node.js HTTPS documentation</a>.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">tls</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;your_key&#39;</span><span class="p">,</span>
        <span class="nx">cert</span><span class="o">:</span> <span class="s1">&#39;your_cert&#39;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
</code></pre>
</div>

<h3 id="toc_3">Router</h3>

<p>The <code>router</code> option controls how incoming request URIs are matched against the routing table. The router only uses the first match found. Router options:</p>

<ul>
<li><code>isCaseSensitive</code> - determines whether the paths &#39;/example&#39; and &#39;/EXAMPLE&#39; are considered different resources. Defaults to <em>true</em>.</li>
<li><code>normalizeRequestPath</code> - determines whether a path should have certain reserved and unreserved percent encoded characters decoded.  Also, all percent encodings will be capitalized that cannot be decoded.  Defaults to <em>false</em>.</li>
<li><code>routeDefaults</code> - sets a default configuration for new routes which is overwritten by each route configuration.</li>
</ul>

<h3 id="toc_4">Payload</h3>

<p>The <code>payload</code> option controls how incoming payloads (request body) are processed. Payload options:</p>

<ul>
<li><code>maxBytes</code> - limits the size of incoming payloads to the specified bytes count. Allowing very large payloads may cause the server to run out of memory. Defaults to <em>1MB</em>.</li>
</ul>

<h3 id="toc_5">Extensions</h3>

<p><strong>hapi</strong> does not support middleware extensibility as is commonly found in other web frameworks. Instead, <strong>hapi</strong> provides extension hooks for
any application-specific functionality. Each extension point accepts a single function or an array of functions to be executed at a specified stage
during request processing. The required extension function signature is <em>function (request, next)</em> where:</p>

<ul>
<li><em>&#39;request&#39;</em> is the <strong>hapi</strong> request object, and</li>
<li><em>&#39;next&#39;</em> is the callback function the method <strong>must</strong> call upon completion to return control over to the router.</li>
</ul>

<p>The extension points are:</p>

<ul>
<li><code>onRequest</code> - called upon new requests before any router processing. The <em>&#39;request&#39;</em> object passed to the <code>onRequest</code> functions is decorated with the <em>&#39;setUrl(url)&#39;</em> and <em>&#39;setMethod(verb)&#39;</em> methods. Calls to these methods will impact how the request is router and can be used for rewrite rules. Should not be used by generic public plugins.</li>
<li><code>onPreAuth</code> - called after parsing cookies, but before authentication. Used primarily for session-based authentication schemes. Skipped if failed to parse cookies.</li>
<li><code>onPreHandler</code> - called after request passes validation and body parsing, before the request handler. Skipped on validation or authentication errors.</li>
<li><code>onPostHandler</code> - called after the request handler, before sending the response. The actual state of the response depends on the response type used (e.g. direct, stream). Skipped if <code>onPreHandler</code> was not called.</li>
<li><code>onPreResponse</code> - called right before the response is sent to the client. Always called.</li>
</ul>

<p>A special <code>request.response()</code> method is available in <code>onPostHandler</code> and <code>onPreResponse</code> which returns the response object. The returned object may be
modified. To return a different response (for example, replace an error with an HTML response), return the new response via <code>next(response)</code>.</p>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="c1">// Create server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

<span class="c1">// Register extension point</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">ext</span><span class="p">(</span><span class="s1">&#39;onRequest&#39;</span><span class="p">,</span> <span class="nx">onRequest</span><span class="p">);</span>

<span class="c1">// Set routes</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/test&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">get</span> <span class="p">});</span>

<span class="c1">// Start server</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

<span class="c1">// Resource handler</span>
<span class="kd">function</span> <span class="nx">get</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">({</span> <span class="nx">status</span><span class="o">:</span> <span class="s1">&#39;ok&#39;</span> <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Path rewrite</span>
<span class="kd">function</span> <span class="nx">onRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Change all requests to &#39;/test&#39;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">setUrl</span><span class="p">(</span><span class="s1">&#39;/test&#39;</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="toc_6">Static Files</h3>

<p><strong>hapi</strong> provides built-in support for serving static files and directories as described in <a href="#file">File</a> and <a href="#directory">Directory</a>.
When these handlers are provided with relative paths, the <code>files.relativeTo</code> server option determines how these paths are resolved
and defaults to <em>&#39;cwd&#39;</em>:</p>

<ul>
<li><em>&#39;cwd&#39;</em> - relative paths are resolved using the active process path (_&#39;process.cwd()&#39;_).</li>
<li><em>&#39;routes&#39;</em> - relative paths are resolved based on the location of the files in which the server&#39;s <em>&#39;route()&#39;</em> method is called. This means the location of the source code determines the location of the static resources when using relative paths.</li>
<li>an absolute prefix path - an absolute path (e.g. &#39;/path&#39;) used as a prefix for all relative paths.</li>
</ul>

<h3 id="toc_7">Views</h3>

<p>To enable Views support, Hapi must be given an options object with a non-null <code>views</code> key. The views object
 supports the following options:</p>

<ul>
<li><code>path</code> - (Required) the root file path where the request.reply.view function will resolve template names.</li>
<li><code>engine</code> - the configuration for what template rendering engine will be used (default: handlebars).

<ul>
<li><code>module</code> - the npm module to require and use to compile templates (**this is experimental and may not not work with all modules**).</li>
<li><code>extension</code> - the file extension used by template files.</li>
</ul></li>
<li><code>engines</code> - optional configuration for supporting multiple rendering engines

<ul>
<li><code>module</code> - the npm module to require and use </li>
</ul></li>
<li><code>partials</code> - this key enables partials support if non-null.

<ul>
<li><code>path</code> - the root file path where partials are located (if different from views.path).</li>
</ul></li>
<li><code>layout</code> - if set to true, layout support is enabled (default: false).</li>
<li><code>layoutKeyword</code> - the key used by the template engine to denote where primary template content should go.</li>
<li><code>encoding</code> - the text encoding used by the templates.</li>
<li><code>cache</code> - if set to false, templates will not be cached (thus will be read from file on every use).</li>
<li><code>allowAbsolutePaths</code> - the flag to set if absolute template paths passed to .view() should be allowed.</li>
<li><code>allowInsecureAccess</code> - the flag to set if <code>../</code> should be allowed in the template paths passed to <code>.view()</code>.</li>
<li><code>compileOptions</code> - the options object passed to the engine&#39;s compile function (compile(string, options)).</li>
</ul>

<h3 id="toc_8">Authentication</h3>

<p><strong>hapi</strong> supports several authentication schemes and can be configured with multiple strategies using these schemes (as well as other
extensions). The built-in schemes provided:</p>

<ul>
<li><em>&#39;basic&#39;</em> - HTTP <a href="#basic-authentication">Basic authentication</a> (<a href="http://tools.ietf.org/html/rfc2617">RFC 2617</a>)</li>
<li><em>&#39;cookie&#39;</em> - simple <a href="#cookie-authentication">cookie authentication</a></li>
<li><em>&#39;hawk&#39;</em> - HTTP <a href="#hawk-authentication">Hawk authentication</a> (<a href="https://github.com/hueniverse/hawk">Hawk protocol</a>)</li>
<li><em>&#39;bewit&#39;</em> - URI <a href="#hawk-bewit-authentication">Hawk Bewit</a> query authentication (<a href="https://github.com/hueniverse/hawk">Hawk protocol</a>)</li>
<li><em>&#39;oz&#39;</em> - experimental web authorization protocol (<a href="https://github.com/hueniverse/oz">Oz protocol</a>)</li>
</ul>

<p>Authentication setup includes two steps:</p>

<ul>
<li>Configure server authentication strategies using the provided schemes (or using an extension implementation). Strategies
are added using the <code>server.auth(name, options)</code> method where:

<ul>
<li>&#39;name&#39; - is the strategy name (&#39;default&#39; is automatically assigned if a single strategy is defined via the server config object).</li>
<li>&#39;options&#39; - required strategy options. Each scheme comes with its own set of required options, in addition to the options shared
by all schemes:

<ul>
<li><code>scheme</code> - the built-in scheme name.</li>
<li><code>implementation</code> - cannot be used together with <code>scheme</code> and is used to provide an object with the <strong>hapi</strong> scheme interface.</li>
<li><code>defaultMode</code> - if &#39;true&#39;, is automatically assigned as a required strategy to any route without an <code>auth</code> config. Can
only be assigned to a single server strategy. Value must be &#39;true&#39; or a valid authentication mode (&#39;required&#39;, &#39;optional&#39;, &#39;try&#39;).</li>
</ul></li>
</ul></li>
<li>Assign strategies to route via the route config as described in <a href="#configuration-options">Configuration options</a>.</li>
</ul>

<p>In addition to the <code>server.auth(name, options)</code> method, the server can be initially configured with a set of strategies using the config
<code>auth</code> key which can be set to a single strategy (name will default to &#39;default&#39;) or an object with multiple strategies where the strategy
name is the object key.</p>

<p>For example, configuring a single strategy:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;basic&#39;</span><span class="p">,</span>
        <span class="nx">loadUserFunc</span><span class="o">:</span> <span class="nx">loadUser</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

<p>And configuring multiple strategies:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">password1</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;basic&#39;</span><span class="p">,</span>
            <span class="nx">loadUserFunc</span><span class="o">:</span> <span class="nx">loadUser1</span>
        <span class="p">},</span>
        <span class="nx">password2</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;basic&#39;</span><span class="p">,</span>
            <span class="nx">loadUserFunc</span><span class="o">:</span> <span class="nx">loadUser2</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

<p>The <em>&#39;examples&#39;</em> folder contains an <em>&#39;auth.js&#39;</em> file demonstrating the creation of a server with multiple authentication strategies.</p>

<h4 id="toc_9">Basic Authentication</h4>

<p>Basic authentication requires validating a username and password combination by looking up the user record via the username and comparing
the provided password with the one stored in the user database. The lookup is performed by a function provided in the scheme configuration
using the <code>loadUserFunc</code> option:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">loadUser</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Lookup user records using username...</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;basic&#39;</span><span class="p">,</span>
        <span class="nx">loadUserFunc</span><span class="o">:</span> <span class="nx">loadUser</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

<p>The <em>&#39;loadUserFunc&#39;</em> callback expects a user object which is passed back once authenticated in <code>request.auth.credentials</code>, but is not
used internally by <strong>hapi</strong>. If the user object is null or undefined, it means the user was not found and the authentication fails.</p>

<p>The provided password is compared to the password received in the request. If the password is hashed, the <code>hashPasswordFunc</code> scheme option
must be provided to hash the incoming plaintext password for comparisson. For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">hashPassword</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">);</span>
    <span class="nx">hash</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
    <span class="nx">hash</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">salt</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="p">};</span>


<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;basic&#39;</span><span class="p">,</span>
        <span class="nx">loadUserFunc</span><span class="o">:</span> <span class="nx">loadUser</span><span class="p">,</span>
        <span class="nx">hashPasswordFunc</span><span class="o">:</span> <span class="nx">hashPassword</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

<h4 id="toc_10">Cookie Authentication</h4>

<p><strong><em>hapi</em></strong> has built-in support for cookie authentication.  Cookie authentication can be enabled with the <em>&#39;cookie&#39;</em> scheme.  Below are the options available in a strategy that is using the <em>&#39;cookie&#39;</em> scheme.</p>

<ul>
<li><code>scheme</code> - &#39;cookie&#39;</li>
<li><code>password</code> - used for deriving a key using PBKDF2</li>
<li><code>ttl</code> - sets the cookie expires time in milliseconds</li>
<li><code>cookie</code> - name of cookie used to save state</li>
<li><code>clearInvalid</code> - when <em>&#39;true&#39;</em> any authentication cookie that fails to authenticate will be marked as expired on the response</li>
<li><code>validateFunc</code> - function that has the signature <em>&#39;(session, callback)&#39;</em> and determines if the session passes authentication.  The callback function has the following signature <em>&#39;(err, override)&#39;</em> where an <em>&#39;err&#39;</em> indicates that authentication failed.  The <em>&#39;override&#39;</em> object will change any cookie properties when setting state on the response.</li>
</ul>

<p>Below is an example of configuring a server to use cookie authentication.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">validateCookie</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">===</span> <span class="s1">&#39;valid&#39;</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;bad user&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;cookie&#39;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span><span class="p">,</span>
        <span class="nx">ttl</span><span class="o">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>                 <span class="c1">// Expire after a minute</span>
        <span class="nx">cookie</span><span class="o">:</span> <span class="s1">&#39;membership&#39;</span><span class="p">,</span>           <span class="c1">// Cookie name</span>
        <span class="nx">clearInvalid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">validateFunc</span><span class="o">:</span> <span class="nx">validateCookie</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</code></pre>
</div>

<h4 id="toc_11">Hawk Authentication</h4>

<p>The <a href="https://github.com/hueniverse/hawk">hawk authentication</a> scheme can be enabled similarly to basic authentication.  Hawk requires a function that takes an <em>&#39;id&#39;</em> and passes credentials to the callback.  Below is an example of a function like this and using it with hapi.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;john&#39;</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">cred</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span>
            <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#39;</span><span class="p">,</span>
            <span class="nx">algorithm</span><span class="o">:</span> <span class="s1">&#39;sha256&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">getCredentials</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">credentials</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">cred</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;hawk&#39;</span><span class="p">,</span>
        <span class="nx">getCredentialsFunc</span><span class="o">:</span> <span class="nx">getCredentials</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</code></pre>
</div>

<p>In the above example only the user &#39;john&#39; can authenticate, all other users will result in an error.</p>

<h4 id="toc_12">Hawk Bewit Authentication</h4>

<p><a href="https://github.com/hueniverse/hawk">Hawk</a> allows for authentication to endpoints by constructing a specially formed URI.  To learn more about this feature in general please read the <a href="https://github.com/hueniverse/hawk#single-uri-authorization">Single URI Authorization</a> section of the hawk readme.  Hapi supports this type of authentication through use of the <em>&#39;bewit&#39;</em> scheme.  Only endpoints using the <em>&#39;GET&#39;</em> HTTP method are allowed to support the <em>&#39;bewit&#39;</em> scheme.  Below is an example of how to enable <em>&#39;bewit&#39;</em> support on a server.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;john&#39;</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">cred</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span>
            <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#39;</span><span class="p">,</span>
            <span class="nx">algorithm</span><span class="o">:</span> <span class="s1">&#39;sha256&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">getCredentials</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">credentials</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">cred</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;bewit&#39;</span><span class="p">,</span>
        <span class="nx">getCredentialsFunc</span><span class="o">:</span> <span class="nx">getCredentials</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</code></pre>
</div>

<p>From a client perspective the URI must contain the <em>&#39;bewit&#39;</em> querystring key with the bewit token value.  Below is an example of constructing a URI to a resource with the <em>&#39;bewit&#39;</em> key.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hawk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hawk&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">cred</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span>
    <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#39;</span><span class="p">,</span>
    <span class="nx">algorithm</span><span class="o">:</span> <span class="s1">&#39;sha256&#39;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">bewit</span> <span class="o">=</span> <span class="nx">Hawk</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">getBewit</span><span class="p">(</span><span class="nx">cred</span><span class="p">,</span> <span class="s1">&#39;/endpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;site.com&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>           <span class="c1">// Valid for 1 minute</span>
<span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="s1">&#39;http://site.com/endpoint?bewit=&#39;</span> <span class="o">+</span> <span class="nx">bewit</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="toc_13">Cache</h3>

<p><strong>hapi</strong> provides built-in caching capabilities for storing and reusing request responses and helpers utilities. The provided
implementations include memory, Redis, and MongoDB support (each server must be manually installed and configured). The cache
functionality is always enabled and if not configured otherwise, defaults to a memory store. The memory store is not suitable
for production environments. Caching will only be utilized if routes, helpers, and plugins explicitly instruct the server to keep
items in the cache.</p>

<p>To change the cache properties, the <code>cache</code> option must be set to an object with the following options:</p>

<ul>
<li><code>engine</code> - the cache server implementation. Options are <em>redis</em>, <em>mongodb</em>, and <em>memory</em>.</li>
<li><code>host</code> - the cache server hostname.</li>
<li><code>port</code> - the cache server port.</li>
<li><code>partition</code> - the partition name used to isolate the cached results across different servers. Defaults to &#39;hapi-cache&#39;. Used as the database name in MongoDB.</li>
<li><code>username</code>, <code>password</code>, <code>poolSize</code> - MongoDB-specific options.</li>
<li><code>maxByteSize</code> - sets an upper limit on the number of bytes that can be stored when using a memory cache. Defaults to no limit.</li>
</ul>

<p>For convenience, pre-configured options are provided for Redis, MongoDB, and memory store. To use them, simply set the server&#39;s <code>cache</code> option to:</p>

<ul>
<li><em>&#39;redis&#39;</em> - Connects to <em>127.0.0.1:6379</em> using partition name &#39;hapi-cache&#39;.</li>
<li><em>&#39;mongodb&#39;</em> - Connects to <em>127.0.0.1:27017</em> using partition name &#39;hapi-cache&#39;, no authentication, and pool size 5.</li>
<li><em>&#39;memory&#39;</em> - This is an experimental engine and should be avoided in production environments.  The memory engine will run within the node process and supports the following option:</li>
</ul>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="o">:</span> <span class="s1">&#39;redis&#39;</span>
<span class="p">};</span>
</code></pre>
</div>

<h3 id="toc_14">CORS</h3>

<p>The <a href="http://www.w3.org/TR/cors/">Cross-Origin Resource Sharing</a> protocol allows browsers to make cross-origin API calls. This is required
by web application running inside a browser which are loaded from a different domain than the API server. <strong>hapi</strong> provides a general purpose
CORS implementation that sets very liberal restrictions on cross-origin access by default (off by default). CORS options:</p>

<ul>
<li><code>origin</code> - overrides the array of allowed origin servers (&#39;Access-Control-Allow-Origin&#39;). Defaults to any origin <em>&#39;*&#39;</em>.</li>
<li><code>maxAge</code> - number of seconds the browser should cache the CORS response (&#39;Access-Control-Max-Age&#39;). The greater the value, the longer it will take before the browser checks for changes in policy. Defaults to <em>one day</em>.</li>
<li><code>headers</code> - overrides the array of allowed headers (&#39;Access-Control-Allow-Headers&#39;). Defaults to <em>&#39;Authorization, Content-Type, If-None-Match&#39;</em>.</li>
<li><code>additionalHeaders</code> - an array of additional headers to <code>headers</code>. Use this to keep the default headers in place.</li>
<li><code>methods</code> - overrides the array of allowed methods (&#39;Access-Control-Allow-Methods&#39;). Defaults to <em>&#39;GET, HEAD, POST, PUT, DELETE, OPTIONS&#39;</em>.</li>
<li><code>additionalMethods</code> - an array of additional methods to <code>methods</code>. Use this to keep the default methods in place.</li>
<li><code>exposedHeaders</code> - overrides the array of exposed headers (&#39;Access-Control-Expose-Headers&#39;). Defaults to <em>&#39;WWW-Authenticate, Server-Authorization&#39;</em>.</li>
<li><code>additionalExposedHeaders</code> - an array of additional headers to <code>exposedHeaders</code>. Use this to keep the default headers in place.</li>
<li><code>credentials</code> - if true, allows user credentials to be sent (&#39;Access-Control-Allow-Credentials&#39;). Defaults to false.</li>
</ul>

<h3 id="toc_15">State</h3>

<p>HTTP state management (cookies) allows the server to store session information on the client which is sent back to the server with every
request (as defined in <a href="https://tools.ietf.org/html/rfc6265">RFC 6265</a>). <strong>hapi</strong> will automatically parse incoming cookies based on the
server&#39;s <code>state.cookies</code> configuration, where:</p>

<ul>
<li><code>parse</code> - determines is incoming &#39;Cookie&#39; headers are parsed and stored in the &#39;request.cookies&#39; object. Defaults to true.</li>
<li><em>&#39;failAction&#39;</em> - allowed values are: <em>&#39;error&#39;</em> (return 500), <em>&#39;log&#39;</em> (report error but continue), or <em>&#39;ignore&#39;</em> (continue) when a request cookie fails parsing. Defaults to <em>&#39;error&#39;</em>.</li>
</ul>

<p>Please note that when using the <em>&#39;log&#39;</em> fail action that the server will emit a <em>&#39;request&#39;</em> event that has a request and event object being passed to any event handler.  For example, the following demonstrates how to check for errors from cookie parsing:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>

   <span class="k">if</span> <span class="p">(</span><span class="nx">tags</span><span class="p">.</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">tags</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
       <span class="c1">// cookie parsing error</span>
   <span class="p">}</span> 
<span class="p">});</span>
</code></pre>
</div>

<h3 id="toc_16">Timeout</h3>

<p>The <code>timeout</code> object can contain <code>server</code>, <code>client</code>, and <code>socket</code> timeout values in milliseconds.  These are useful for limiting the amount of time a request or response should take to complete.</p>

<h4 id="toc_17">Server Timeout</h4>

<p>In order to indicate when a server or dependent services are overwhelmed set the <em>&#39;timeout.server&#39;</em> property.  This property should be set to the maximum number of milliseconds to allow a server response to take before responding with a 503 status code.  By default <em>&#39;timeout.server&#39;</em> is disabled.</p>

<p>The server timeout is measured as the time from executing a hapi request until a response is generated for the request and validated.  If an endpoint takes longer than the timeout to generate a response the response will not be cached.</p>

<p>The example below demonstrates how to force the server to timeout when it takes the server longer than 10 seconds to begin responding to a request:
<code>{ timeout: { server: 10000 } }</code></p>

<h4 id="toc_18">Client Timeout</h4>

<p>In order to indicate to a client that they are taking too long to send a request the <em>&#39;timeout.client&#39;</em> option should be set.  By default this value is set to 10000 ms.  As a result, any request taking longer than 10 seconds to complete will error out with a 408 status code.  Below is an example of disabling the client timeout:
<code>{ timeout: { client: false } }</code></p>

<h4 id="toc_19">Socket Timeout</h4>

<p>In node, server requests automatically time out after 2 minutes. To override this value set the <code>socket</code> timeout value.
Defaults to &#39;null&#39; which leaves the node default as-is. Below is an example of changing the socket timeout to :
<code>{ timeout: { socket: 3 * 60 * 1000 } }</code></p>

<h3 id="toc_20">Debug</h3>

<p>By default, <strong>hapi</strong> does not print much to the console. However, it is set to output any uncaught errors thrown in non-hapi code as those are handled
automatically and result in a 500 error response. To change the type of events logged to the console, change the server config <code>debug.request</code> array to
the list of request log tags you would like to see no the console. For example, also print error events:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">debug</span><span class="o">:</span> <span class="p">{</span> <span class="nx">request</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;uncaught&#39;</span><span class="p">]</span> <span class="p">}</span> <span class="p">});</span>
</code></pre>
</div>

<p>To turn off all console print outs:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">debug</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
</code></pre>
</div>

<h2 id="toc_21">Server Events</h2>

<p>The server object emits the following events:</p>

<ul>
<li><em>&#39;log&#39;</em> - <a href="#server-logging">general server events</a>.</li>
<li><em>&#39;request&#39;</em> - events generated by the <a href="#request-logging">request logging method</a>. Multiple events per request.</li>
<li><em>&#39;response&#39;</em> - emitted after a response is sent back. Includes the request object as value. Single event per request.</li>
<li><em>&#39;tail&#39;</em> - emitted when a request finished processing, including any registered tails as described in <a href="#request-tails">Request Tails</a>. Single event per request.</li>
<li><em>&#39;internalError&#39;</em> - emitted whenever a 500 response is sent. Single event per request.</li>
</ul>

<p>When provided, event objects include:</p>

<ul>
<li><code>timestamp</code> - the event timestamp</li>
<li><code>id</code> - if the event relates to a request, the request id</li>
<li><code>tags</code> - an array of tags (e.g. &#39;error&#39;, &#39;http&#39;)</li>
<li><code>data</code> - optional event-specific data</li>
</ul>

<p>The <em>&#39;log&#39;</em> event includes the event object and a tags object (where each tag is a key with the value <code>true</code>):</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">tags</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Server error: &#39;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The <em>&#39;request&#39;</em> event includes the request object, the event object, and a tags object (where each tag is a key with the value <code>true</code>):</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">tags</span><span class="p">.</span><span class="nx">received</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;New request: &#39;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The <em>&#39;response&#39;</em> and <em>&#39;tail&#39;</em> events include the request object:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Response sent for request: &#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The <em>&#39;internalError&#39;</em> event includes the request object and the causing Error object:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;internalError&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error response (500) sent for request: &#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; because: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<h2 id="toc_22">Server Route Not Found</h2>

<p><strong>hapi</strong> provides a default handler for unknown routes (HTTP 404). If the application needs to override the default handler, it can add a
new catch-all route for a specific method or all methods:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="c1">// Create server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="mi">8000</span><span class="p">);</span>

<span class="c1">// Override the default 404 handler</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/{p*}&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">notFoundHandler</span> <span class="p">});</span>

<span class="c1">// Start server</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

<span class="c1">// 404 handler</span>
<span class="kd">function</span> <span class="nx">notFoundHandler</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">Hapi</span><span class="p">.</span><span class="nb">Error</span><span class="p">.</span><span class="nx">notFound</span><span class="p">(</span><span class="s1">&#39;The page was not found&#39;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="toc_23">Route Configuration</h2>

<p><strong>hapi</strong> was designed to move as much logic as possible from the route handler to the route configuration. The goal is to provide a simple
mechanism for defining routes without having to write code. This approach also enables producing dynamic route documentation without having
to write additional text as the configuration itself serves as a living documentation.</p>

<h3 id="toc_24">Configuration options</h3>

<ul>
<li><code>path</code> - the absolute path or regular expression to match against incoming requests. Path comparison is configured using the server <a href="#router"><code>router</code></a> option. String paths can include named identifiers enclosed in <em>&#39;{}&#39;</em> as described in <a href="#path-processing">Path Parameters</a>.</li>
<li><code>method</code> - the HTTP method. Typically one of <em>&#39;GET, POST, PUT, DELETE, OPTIONS&#39;</em>. Any HTTP method is allowed, except for <em>&#39;HEAD&#39;</em>. <strong>hapi</strong> does not provide a way to add a route to all methods.</li>
<li><code>vhost</code> - an optional domain string or array of domain strings for limiting the route to only requests with a matching host header field. Defaults to all hosts.</li>
<li><code>handler</code> - the business logic function called after authentication and validation to generate the response. The function signature is <em>function (request)</em> where <em>&#39;request&#39;</em> is the <strong>hapi</strong> request object. See <a href="#route-handler">Route Handler</a> for more information.  Optionally, this can be an object with a <em>&#39;proxy&#39;</em>, <em>&#39;file&#39;</em>, or <em>&#39;directory&#39;</em> property:

<ul>
<li><code>proxy</code> - generates a reverse proxy handler as described in (Proxy)[#proxy].</li>
<li><code>file</code> - generates a static file endpoint as described in (File)[#file].</li>
<li><code>directory</code> - generates a directory mapper for service static content as described in (Directory)[#directory].</li>
</ul></li>
<li><code>config</code> - route configuration grouped into a sub-object to allow splitting the routing table from the implementation details of each route. Options include:

<ul>
<li><code>description</code> - route description.</li>
<li><code>notes</code> - route notes (string or array of strings).</li>
<li><code>tags</code> - route tags (array of strings).</li>
<li><code>handler</code> - an alternative location for the route handler function. Same as the <code>handler</code> option in the parent level. Can only include one handler per route.</li>
<li><code>validate</code>

<ul>
<li><code>query</code> - validation rules for incoming requests&#39; query component (the key-value part of the URI between <em>?</em> and <em>#</em>). Defaults to any query parameters being allowed. See <a href="#query-validation">Query Validation</a> for more information.</li>
<li><code>payload</code> - validation rules for incoming requests&#39; payload (request body). Defaults to no validation (any payload allowed). Set to <em>&#39;false&#39;</em> to forbid payloads. See <a href="#payload-validation">Payload Validation</a> for more information.</li>
<li><code>path</code> - validation rules for incoming requests&#39; path parameters. Defaults to no validation (any path parameter allowed). Set to <em>&#39;false&#39;</em> to forbid any path parameter. See <a href="#path-validation">Path Validation</a> for more information.</li>
</ul></li>
<li><code>response</code> - validation rules for outgoing responses&#39; payload (response body). Defaults to no validation (any payload allowed). Set to an empty object <em>&#39;{}&#39;</em> to forbid payloads. See <a href="#response-validation">Response Validation</a> for more information.</li>
<li><code>payload</code> - determines how the request payload is processed. Defaults to <em>&#39;parse&#39;</em> if <code>schema</code> is present or <code>method</code> is <em>&#39;POST&#39;</em> or <em>&#39;PUT&#39;</em>, otherwise <em>&#39;stream&#39;</em>. Payload processing is configured using the server <a href="#payload"><code>payload</code></a> option. Options are:

<ul>
<li><em>&#39;stream&#39;</em> - the incoming request stream is left untouched, leaving it up to the handler to process the request via <em>&#39;request.raw.req&#39;</em>. Note that the request readable stream is put in a paused state and must be resumed before it will emit data events.</li>
<li><em>&#39;raw&#39;</em> - the payload is read and stored in <em>&#39;request.rawPayload&#39;</em> as a Buufer and is not parsed.</li>
<li><em>&#39;parse&#39;</em> - the payload is read and stored in <em>&#39;request.rawPayload&#39;</em> as a Buffer, and then parsed (JSON or form-encoded) and stored in <em>&#39;request.payload&#39;</em>.</li>
</ul></li>
<li><code>cache</code> - if the the route method is &#39;GET&#39;, the route can be configured to use the cache as described in <a href="#caching">Caching</a>.</li>
<li><code>pre</code> - an array with pre-handler methods as described in <a href="#prerequisites">Route Prerequisites</a>. </li>
<li><code>auth</code> - authentication configuration

<ul>
<li><code>mode</code> - the authentication mode. Defaults to <em>&#39;required&#39;</em> is the <code>authentication</code> server option is set, otherwise <em>&#39;none&#39;</em>. Available options include:

<ul>
<li><em>&#39;none&#39;</em> - authentication not allowed.</li>
<li><em>&#39;required&#39;</em> - authentication is required.</li>
<li><em>&#39;optional&#39;</em> - authentication is optional (validated if present).</li>
</ul></li>
<li><code>tos</code> - minimum terms-of-service version required. This is compared to the terms-of-service version accepted by the user. Defaults to <em>none</em>.</li>
<li><code>scope</code> - required application scope. Defaults to <em>none</em>.</li>
<li><code>entity</code> - the required authenticated entity type. Not supported with every authorization scheme. Available options include:

<ul>
<li><em>&#39;any&#39;</em> - the authentication can be on behalf of a user or application.</li>
<li><em>&#39;user&#39;</em> - the authentication must be on behalf of a user.</li>
<li><em>&#39;app&#39;</em> - the authentication must be on behalf of an application.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>The <code>config</code> option was defined for easily splitting the routing table definition from the individual route information. For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">();</span>

<span class="c1">// Option 1 - add handler directly in route definition</span>

<span class="kd">var</span> <span class="nx">handler1</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/option1&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">handler1</span> <span class="p">});</span>

<span class="c1">// Option 2 - add handler in separate config object</span>

<span class="kd">var</span> <span class="nx">config2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">payload</span><span class="o">:</span> <span class="s1">&#39;raw&#39;</span><span class="p">,</span>
    <span class="c1">// ... additional config options ...</span>
    <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/option2&#39;</span><span class="p">,</span> <span class="nx">config</span><span class="o">:</span> <span class="nx">config2</span><span class="p">});</span>
</code></pre>
</div>

<h3 id="toc_25">Path Processing</h3>

<p>The <strong>hapi</strong> router iterates through the routing table on each incoming request and executes the first (and only the first) matching route handler.
Route matching is done on the request path only (excluding the query and other components). The route <code>path</code> option support three types of paths:</p>

<ul>
<li>Static - the route path is a static string which begin with <em>&#39;/&#39;</em> and will only match incoming requests containing the exact string match (as defined by the server <code>router</code> option).</li>
<li>Parameterized - same as <em>static</em> with the additional support of named parameters (enclosed in <em>&#39;{}&#39;</em>).</li>
</ul>

<h4 id="toc_26">Route Matching Order</h4>

<p><strong>hapi</strong> matches incoming requests in a deterministic order. This means the order in which routes are added does not
matter. To achieve this, <strong>hapi</strong> uses a set of rules to sort the routes from the most specific to the most generic. For example, the following
path array shows the order in which an incoming request path will be matched against the routes, regardless of the order they are added:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/b&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/ab&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/{p}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/b&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/{p}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/b/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/b/c&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/b/{p}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/{p}/b&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/{p}/c&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/{p*2}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/b/c/d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/b/{p*2}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/{p}/b/{x}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/{p*5}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/a/b/{p*}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/{p*}&#39;</span>
<span class="p">];</span>
</code></pre>
</div>

<h4 id="toc_27">Parameters</h4>

<p>Parameterized paths are processed by matching the named parameters to the content of the incoming request path at that level. For example, the route:
&#39;/book/{id}/cover&#39; will match: &#39;/book/123/cover&#39; and &#39;request.params.id&#39; will be set to &#39;123&#39;. Each path level (everything between the opening <em>&#39;/&#39;</em> and
 the closing <em>&#39;/&#39;</em> unless it is the end of the path) can only include one named parameter. The <em>&#39;?&#39;</em> suffix following the parameter name indicates
an optional parameter (only allowed if the parameter is at the ends of the path). For example: the route: &#39;/book/{id?}&#39; will match: &#39;/book/&#39;.</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/{album}/{song?}&#39;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="nx">handler</span><span class="o">:</span> <span class="nx">getAlbum</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getAlbum</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;You asked for &#39;</span> <span class="o">+</span>
                <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">song</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">song</span> <span class="o">+</span> <span class="s1">&#39; from &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">album</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In addition to the optional <em>&#39;?&#39;</em> suffix, a param can also specify an expected number of parts in the path.  To do this use the <em>&#39;*&#39;</em> suffix followed by a number greater than 1.  If the number of expected parts can be anything, then use the <em>&#39;*&#39;</em> without a number.</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/person/{names*2}&#39;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="nx">handler</span><span class="o">:</span> <span class="nx">getPerson</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getPerson</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">nameParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="k">new</span> <span class="nx">Person</span><span class="p">(</span><span class="nx">namesParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">nameParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In the example code above if a request for <code>/person/john/smith</code> comes in then <code>request.params.names</code> is set to &#39;john/smith&#39;.  In this example a person will be returned for the john smith.</p>

<p>Below is a similar example without a requirement on the number of name parts that can be passed.</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/people/{names*}&#39;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="nx">handler</span><span class="o">:</span> <span class="nx">getPerson</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getPeople</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">nameParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">loadPeople</span><span class="p">(</span><span class="nx">namesParts</span><span class="p">));</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In the example people are loaded by passing in a names array.  If a request comes in for <code>people/john/bob/jenny</code> then <code>request.params.names</code> is set to &#39;john/bob/jenny&#39;.  Please note that the route will be matched for a request of <code>/people/</code> as names can be 0 or more parts.  As a result of this behavior, {names*} must appear as the last parameter in the route path.  In other words, a param with 0 or more path parts must appear at the end of the end of the route path.</p>

<h3 id="toc_28">Request Payload Parsing</h3>

<p>Incoming requests that contain a payload and a supported &#39;Content-Type&#39; header are parsed when the route <em>&#39;payload&#39;</em> option is set to <em>&#39;parse&#39;</em>.  Currently, the following &#39;Content-Type&#39; header values are parsed and assigned to the <code>request.payload</code> object.</p>
<div class="highlight"><pre><code class="text">- application/json
- application/x-www-form-urlencoded
- multipart/form-data
</code></pre>
</div>

<p>When parsing is enabled for a route and the request has a payload and an unsupported &#39;Content-Type&#39; header an error will be returned to the client.</p>

<p>The module <a href="https://npmjs.org/package/formidable">formidable</a> is used for processing the &#39;multipart/form-data&#39;.  Formidable is capable of receiving files as well as other form data.  All values are assigned to their respective form names on the <em>&#39;payload&#39;</em> object.  </p>

<h3 id="toc_29">Route Handler</h3>

<p>Route handlers can use one of three declaration styles:</p>

<p>No arguments (the request object is bound to <code>this</code>, decorated by the <code>reply</code> interface):</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<p>One argument (the request is passed as an argument, decorated by the <code>reply</code> interface):</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<p>Two arguments (the request and the <code>reply</code> interface are passed as arguments):</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<p><strong>Note</strong>: The two-arguments style is provided for symmetry with extension functions and prerequisite functions where the function
signature is <em>&#39;function (request, next)&#39;</em>. In order to enable interchangeable use of these functions, the two argument style does
not provide any of the reply method decorations listed under <a href="#response">handler response</a> (e.g. you must call &#39;reply(result);&#39;).</p>

<p>When the provided route handler method is called, it receives a <em>request</em> object with the following properties:</p>

<ul>
<li><em>&#39;url&#39;</em> - the parsed request URI.</li>
<li><em>&#39;path&#39;</em> - the request URI&#39;s path component.</li>
<li><em>&#39;method&#39;</em> - the request method as a <em>lowercase</em> string. (Examples: <code>&#39;get&#39;</code>, <code>&#39;post&#39;</code>).</li>
<li><em>&#39;query&#39;</em> - an object containing the query parameters.</li>
<li><em>&#39;params&#39;</em> - an object containing the path named parameters as described in <a href="#parameters">Path Parameters</a>.</li>
<li><em>&#39;rawPayload&#39;</em> - the raw request payload Buffer (except for requests with <code>config.payload</code> set to <em>&#39;stream&#39;</em>).</li>
<li><em>&#39;payload&#39;</em> - an object containing the parsed request payload (for requests with <code>config.payload</code> set to <em>&#39;parse&#39;</em>).</li>
<li><em>&#39;state&#39;</em> - an object containing parsed HTTP state information (cookies).</li>
<li><em>&#39;session&#39;</em> - available for authenticated requests and includes:

<ul>
<li><em>&#39;id&#39;</em> - session identifier.</li>
<li><em>&#39;user&#39;</em> - user id (optional).</li>
<li><em>&#39;app&#39;</em> - application id (optional).</li>
<li><em>&#39;scope&#39;</em> - approved application scopes (optional).</li>
<li><em>&#39;ext.tos&#39;</em> - terms-of-service version (optional).</li>
</ul></li>
<li><em>&#39;server&#39;</em> - a reference to the server object.</li>
<li><em>&#39;pre&#39;</em> - any requisites as described in <a href="#prequisites">Prequisites</a>.</li>
<li><em>&#39;addTail([name])&#39;</em> - adds a request tail as described in <a href="#request-tails">Request Tails</a>.</li>
<li><em>&#39;raw&#39;</em> - an object containing the Node HTTP server &#39;req&#39; and &#39;req&#39; objects. <strong>Direct interaction with these raw objects is not recommended.</strong></li>
</ul>

<p>In addition, the handler method is bound to the request object which is also available using <em>this</em>:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Hello &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<h4 id="toc_30">Response</h4>

<p><strong>hapi</strong> provides native support for the following response types:</p>

<ul>
<li>Empty - an empty response body (content-length of zero).</li>
<li>Text - plain text. Defaults to &#39;text/html&#39; content-type.</li>
<li>Obj - Javascript object, converted to string. Defaults to &#39;application/json&#39; content-type.</li>
<li>Stream - a stream object, directly piped into the HTTP response.</li>
<li>File - transmits a static file. Defaults to the matching mime type based on filename extension.</li>
<li>Direct - special response type for writing directly to the response object. Used for chunked responses.</li>
<li>Error - error objects generated using the &#39;Hapi.error&#39; module or &#39;new Error()&#39; described in <a href="#response-errors">Response Errors</a>.</li>
</ul>

<p>Based on the handler function declaration style, a <em>&#39;reply&#39;</em> function is provided which includes the following properties:</p>

<ul>
<li><em>&#39;payload(result)&#39;</em> - sets the provided <em>&#39;result&#39;</em> as the response payload. <em>&#39;result&#39;</em> cannot be a Stream. The method will automatically
identify the result type and cast it into one of the supported response types (Empty, Text, Obj, or Error). <em>&#39;result&#39;</em> can all be an
instance of any other response type provided by the &#39;Hapi.response&#39; module (e.g. File, Direct).</li>
<li><em>&#39;stream(stream)&#39;</em> - pipes the content of the stream into the response.</li>
<li><em>&#39;redirect(uri)&#39;</em> - sets a redirection response. Defaults to 302.</li>
<li><em>&#39;send()&#39;</em> - finalizes the response and return control back to the router. Must be called after <em>&#39;payload()&#39;</em> or <em>&#39;stream()&#39;</em> to send the response.</li>
<li><em>&#39;close()&#39;</em> - closes the response stream immediately without flushing any remaining unsent data. Used for ending the handler execution
after manually sending a response.</li>
</ul>

<p>For convenience, the reply function can be simply invoke as <em>&#39;reply([result])&#39;</em> which is identical to calling <em>&#39;reply.payload([result]).send()&#39;</em> or <em>&#39;reply.stream(stream).send()&#39;</em>, depending on the result.</p>

<p>The &#39;payload()&#39;, &#39;stream()&#39;, and &#39;redirect()&#39; methods return a <strong>hapi</strong> Response object created based on the result item provided.
Depending on the response type, additional chainable methods are available:</p>

<ul>
<li><em>&#39;created(location)`</em> - a URI value which sets the HTTP response code to 201 (Created) and adds the HTTP <em>Location</em> header with the provided value (normalized to absolute URI). Not available with &#39;redirect()&#39;.</li>
<li><em>&#39;bytes(length)&#39;</em> - a pre-calculated Content-Length header value. Only available when using <em>&#39;pipe(stream)&#39;</em>.</li>
<li><em>&#39;type(mimeType)&#39;</em> - a pre-determined Content-Type header value. Should only be used to override the built-in defaults.</li>
<li><em>&#39;ttl(msec)&#39;</em> - a milliseconds value which overrides the default route cache expiration rule for this individual response.</li>
<li><em>&#39;state(name, value, options)&#39;</em> - sets an HTTP state (cookie) as described in <a href="#raw-cookies">Raw Cookies</a></li>
<li><em>&#39;unstate(name)&#39;</em> - instructs the client to remove the HTTP state.</li>
<li><em>&#39;header(name, value)&#39;</em> - sets a HTTP header with the provided value.</li>
</ul>

<p>The following methods are only available when using &#39;redirect()&#39;:</p>

<ul>
<li><em>&#39;message(text, type)&#39;</em> - a payload message and optional content type (defaults to &#39;text/html&#39;).</li>
<li><em>&#39;uri(dest)&#39;</em> - the destination URI.</li>
<li><em>&#39;temporary()</em>&#39; - sets the status code to 302 or 307 (based on the rewritable settings). Defaults to &#39;true&#39;.</li>
<li><em>&#39;permanent()</em>&#39; - sets the status code to 301 or 308 (based on the rewritable settings). Defaults to &#39;false&#39;.</li>
<li><em>&#39;rewritable(isRewritable)</em>&#39; - sets the status code to 301/302 (based on the temporary settings) for rewritable (change POST to GET) or 307/308 for non-rewritable. Defaults to &#39;true&#39;.</li>
</ul>

<p>The handler must call <em>&#39;reply()&#39;</em>, <em>&#39;reply.send()&#39;</em>, or <em>&#39;reply.payload/stream()...send()&#39;</em> (and only one, once) to return control over to the router. The reply methods are only available
within the route handler and are disabled as soon as control is returned.</p>

<h4 id="toc_31">Proxy</h4>

<p>It is possible with hapi to setup a reverse proxy for routes.  This is especially useful if you plan to stand-up hapi in front of an existing API or you need to augment the functionality of an existing API.  Additionally, this feature is powerful in that it can be combined with caching to cache the responses from external APIs.  The proxy route configuration has the following options:</p>

<ul>
<li><code>passThrough</code> - determines if the headers sent from the clients user-agent will be forwarded on to the external service being proxied to (default: false)</li>
<li><code>xforward</code> - determines if the x-forward headers will be set when making a request to the proxied endpoint (default: false)</li>
<li><code>host</code> - The host to proxy requests to.  The same path on the client request will be used as the path to the host.</li>
<li><code>port</code> - The port to use when making a request to the host.</li>
<li><code>protocol</code> - The protocol to use when making a request to the proxied host (http or https)</li>
<li><code>mapUri</code> - A function used to map the request URI to the proxied URI. The function signature is <em>function (request, callback)</em> where &#39;request&#39; is the incoming request object, and callback is &#39;function (err, uri)&#39;.  Cannot be used together with <code>host</code>, <code>port</code>, or <code>protocol</code>.</li>
<li><code>postResponse</code> - A function that will be executed before sending the response to the client for requests that can be cached.  Use this for any custom error handling of responses from the proxied endpoint.</li>
<li><code>httpClient</code> - A function that should make the request to the remote server and use execute the callback with a response.  By default this uses <em>&#39;request&#39;</em> as the module.  The signature is (options, callback) where options will contain a url and method.</li>
</ul>

<p>For example, to proxy a request to the homepage to google:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi servers</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="c1">// Proxy request to / to google.com</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">proxy</span><span class="o">:</span> <span class="p">{</span> <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;google.com&#39;</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">80</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>Using <code>mapUri</code>:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">mapper</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;https://www.google.com/?q=&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">.</span><span class="nx">term</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/{term}&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">proxy</span><span class="o">:</span> <span class="p">{</span> <span class="nx">mapUri</span><span class="o">:</span> <span class="nx">mapper</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>
</code></pre>
</div>

<h4 id="toc_32">File</h4>

<p>File handlers provide a simple way to serve a static file for a given route. This is done by specifying an object with the <code>file</code>
option as the route handler. The value of the <code>file</code> option is the absolute or relative path to the static resource. Relative paths
are resolved based on the server&#39;s <code>files</code> option as described in (Files)[#files]. The route path cannot contain parameters when
configured with a static file path. For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="p">{</span> <span class="nx">files</span><span class="o">:</span> <span class="p">{</span> <span class="nx">relativeTo</span><span class="o">:</span> <span class="s1">&#39;cwd&#39;</span> <span class="p">}</span> <span class="p">});</span>

<span class="c1">// Serve index.html file up a directory in the public folder</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">file</span><span class="o">:</span> <span class="s1">&#39;./public/index.html&#39;</span> <span class="p">}</span> <span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>The file handler also supports dynamic determination of the file being served based on the request, using a function as the value
of the <code>file</code> option with the signature <em>&#39;function (request) { return &#39;./path&#39;; }&#39;</em>.  The function is passed the request object and
must return a string with the relative or absolute path to the static resource. For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="c1">// File mapping function</span>
<span class="kd">var</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isMobileDevice</span><span class="p">(</span><span class="nx">request</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;./mobile/&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s1">&#39;./public&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/{path}&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">file</span><span class="o">:</span> <span class="nx">filePath</span> <span class="p">}</span> <span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>File handlers also support specifying if the <em>&#39;Content-Disposition&#39;</em> should be sent on the response.  The default is to not send this header, however if it needs to be sent there is an optional <em>&#39;mode&#39;</em> property that can be set to <em>&#39;attachment&#39;</em>, <em>&#39;inline&#39;</em>, or false.  Below is an example setting the mode to <em>&#39;attachment&#39;</em>.</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="p">{</span> <span class="nx">files</span><span class="o">:</span> <span class="p">{</span> <span class="nx">relativeTo</span><span class="o">:</span> <span class="s1">&#39;cwd&#39;</span> <span class="p">}</span> <span class="p">});</span>

<span class="c1">// Serve index.html file up a directory in the public folder</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">file</span><span class="o">:</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;./public/index.html&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="err">&#39;</span><span class="nx">attachment</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>Please note, that when setting <em>&#39;file&#39;</em> to an object, the file path is assigned to the <em>&#39;path&#39;</em> property.</p>

<h4 id="toc_33">Directory</h4>

<p>Directory handlers provide a flexible way to serve static content from an entire directory tree. Similar to other web servers, <strong>hapi</strong>
allows mapping between a request path component to resources within a file system directory, including serving a default index.html or
a directory content listing.</p>

<p>Routes utilizing the directory handler must include a single path parameter at the end of the path string (e.g. <em>&#39;/path/to/somewhere/{param}&#39;</em>).
The directory handler is an object with the following options:</p>

<ul>
<li><code>path</code> - a required path string, an array of strings, or function. If the <code>path</code> is a string, it is used as the prefix for any resources requested within the route by appending the required route path parameter to the provided string. An array of string will be attemped in order until a match is found. Alternatively, the <code>path</code> can be a function with the signature <em>&#39;function (request) { return &#39;./path&#39;; }&#39;</em>.  The function is passed the request object and must return a string with the relative or absolute path to the static resource. Relative paths are resolved based on the server&#39;s <code>files</code> option as described in (Files)[#files].</li>
<li><code>index</code> - optional boolean, determines if &#39;index.html&#39; will be served if exists in the folder when requesting a directory. Defaults to <em>&#39;true&#39;</em>.</li>
<li><code>listing</code> - optional boolean, determines if directory listing is generated when a directory is requested without an index document. Defaults to <em>&#39;false&#39;</em>.</li>
<li><code>showHidden</code> - optional boolean, determines if hidden files will be shown and served.  Defaults to <em>&#39;false&#39;</em>.</li>
</ul>

<p>The required route path parameter can use any of the parameter options (e.g. &#39;{param}&#39;, &#39;{param?}&#39;, &#39;{param*}&#39;). For example, to server
only files in the top level folder and not to any subfolder use <em>&#39;{path?}&#39;</em>. If it is safe to navigate to child folders and files then
use <em>&#39;{path*}&#39;</em>. Similarly, if the server should only allow access to a certain level of subfolders then use <em>&#39;{path*2}&#39;</em>.</p>

<p>The following example shows how to serve a directory named <em>&#39;public&#39;</em> and enable a directory listing in case a &#39;index.html&#39; file doesn&#39;t exist:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="c1">// Serve the public folder with listing enabled</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/{path*}&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">directory</span><span class="o">:</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;./public/&#39;</span><span class="p">,</span> <span class="nx">listing</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>A function <code>path</code> can be used to serve different directory trees based on the incoming request. For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">directoryPath</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isMobileDevice</span><span class="p">(</span><span class="nx">request</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;./mobile&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s1">&#39;./public&#39;</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/{path*}&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">directory</span><span class="o">:</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="nx">directoryPath</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<h4 id="toc_34">View</h4>

<p>Views provide a better way of generating HTML than string and variable concatenation. Similar to other web servers, 
<strong>hapi</strong> views allow handlers to efficiently generate HTML using templates by executing an individual template with a
pre-generated context object (which may contain dynamic content).</p>

<p>The following example shows how to render a basic handlebars/mustache template:</p>

<p><strong>index.js</strong></p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Views Example&#39;</span><span class="p">,</span>
        <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Hello, World&#39;</span>
    <span class="p">}).</span><span class="nx">send</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">handler</span> <span class="p">});</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>An example template:</p>

<p><strong>templates/index.html</strong></p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;h1&gt;&lt;/h1&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>On request, the user would be shown:</p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>Views Example<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;h1&gt;</span>Hello, World<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>The Hapi.Server settings may also be overridden on a per view basis without affecting others:</p>
<div class="highlight"><pre><code class="text">request.render.view(tmpl, ctx, { path: &#39;/a/different/path&#39; });
</code></pre>
</div>

<p>Full working examples covering features such as layouts and partials can be found in the <code>examples/views/handlebars</code> folder.</p>

<h4 id="toc_35">Views Handler</h4>

<p>The route handler can be set to an object that points to a view file in order to make it easy to render a simple view.  The view context will have the payload, params, or querystring data that are available with the request.  For example, to render an <em>&#39;about&#39;</em> page a route can be added as follows:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/{user}/about&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="p">{</span> <span class="nx">view</span><span class="o">:</span> <span class="err">&#39;</span><span class="nx">about</span> <span class="p">});</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>Then in the view there are properties for params, payload, and querystring.  Below is an example of rendering the <em>&#39;user&#39;</em> that is passed in from the request path along with related values from the querystring.</p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>About <span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;h1&gt;</span>About <span class="nt">&lt;/h1&gt;</span>
            <span class="nt">&lt;div&gt;</span>
                Age: 
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div&gt;</span>
                Interests: 
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<h4 id="toc_36">Layouts</h4>

<p>The View system supports Layouts. Layouts are a single template file which is used as a parent template for individual view templates - the view template is directly embedded in a layout. This allows developers to give the website(s) a consistent appearance while also keeping HTML code as well as minimizing repeated code (the boilerplate with stylesheet includes, javascript includes, html displayed on every page).</p>

<p>To use, set the Hapi view option <code>layout</code> to true and create a file <code>layout.html</code> in your <code>views.path</code>.</p>

<p><strong>layout.js</strong></p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span><span class="p">,</span>
        <span class="nx">engine</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">module</span><span class="o">:</span> <span class="s1">&#39;handlebars&#39;</span><span class="p">,</span>
            <span class="nx">extension</span><span class="o">:</span> <span class="s1">&#39;html&#39;</span>
        <span class="p">},</span>
        <span class="nx">layout</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;withLayout/index&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;examples/views/layout.js | Hapi &#39;</span> <span class="o">+</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">version</span><span class="p">(),</span>
        <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Hello World!\n&#39;</span>
    <span class="p">}).</span><span class="nx">send</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="mi">8080</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">handler</span> <span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p><strong>templates/layout.html</strong></p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;p&gt;</span>Layout header<span class="nt">&lt;/p&gt;</span>
        }
        <span class="nt">&lt;p&gt;</span>Layout footer<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p><strong>templates/withLayout/index.html</strong></p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;h1&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p><strong>returned to user</strong>:</p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>examples/views/layout.js | Hapi 0.11.1<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;p&gt;</span>Layout header<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;h1&gt;</span>Hello World!\n<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;p&gt;</span>Layout footer<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>The <code>layout.html</code> must be located in the path or an error will be returned. Notice that the content from view template <code>withLayout/index</code> is executed with the context provided in the handler then embedded into the layout in place of <code>}</code>. To change the keyword for embedding the view template, set the <code>layoutKeyword</code> option.</p>

<h4 id="toc_37">Partials</h4>

<p>The View system also supports Partials. Partials are small segments of template code that can be nested and reused throughout other templates.</p>

<p><strong>partials.js</strong></p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span><span class="p">,</span>
        <span class="nx">engine</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">module</span><span class="o">:</span> <span class="s1">&#39;handlebars&#39;</span>
        <span class="p">},</span>
        <span class="nx">partials</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">path</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/templates/withPartials&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;withPartials/index&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;examples/views/partials.js | Hapi &#39;</span> <span class="o">+</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">version</span><span class="p">(),</span>
        <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Hello World!\n&#39;</span>
    <span class="p">}).</span><span class="nx">send</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">handler</span> <span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p><strong>withPartials/index.html</strong></p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>

        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;h1&gt;&lt;/h1&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p><strong>withPartials/header.html</strong></p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Views with Partials<span class="nt">&lt;/h3&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p><strong>withPartials/footer.html</strong></p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;footer&gt;</span>
    <span class="nt">&lt;p&gt;</span>hapi.js 2013<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</code></pre>
</div>

<p><strong>returned to user</strong></p>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>examples/views/partials.js | Hapi 0.11.1<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;h3&gt;</span>Views with Partials<span class="nt">&lt;/h3&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;h1&gt;</span>Hello World!\n<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;footer&gt;</span>
            <span class="nt">&lt;p&gt;</span>hapi.js 2013<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/footer&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>The above example will use <code>views.partials.path</code> as the partials directory. Hapi will recursively find template files and automatically add them to the partial registry for use in view templates. </p>

<p>Deeply nested partials are also supported.  A view template can reference a partial stored in <code>viewsPath/nav/nav.html</code> like so:</p>
<div class="highlight"><pre><code class="html">    <span class="nt">&lt;body&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
    ...
</code></pre>
</div>

<h4 id="toc_38">Multiple Engines</h4>

<p>Multiple engine support is functional for most templating systems (particularly those that employ a .compile function). Thus,
 multiple templating systems may be used in a single Hapi instance. Custom options may be passed to each .view function to
 customize compile options on a per endpoint basis - the functions behave as they would on a single-engine setup.</p>

<p>Hapi distinguishes between the engines by checking which file extension has been configured by a particular templating engine.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;examples/views/mixed/basic.js | Hapi &#39;</span> <span class="o">+</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">version</span><span class="p">(),</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Hello World!&#39;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">oneHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">).</span><span class="nx">send</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">twoHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;handlebars&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">).</span><span class="nx">send</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span><span class="p">,</span>
        <span class="nx">engines</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;html&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">module</span><span class="o">:</span> <span class="s1">&#39;handlebars&#39;</span> <span class="p">},</span>
            <span class="s1">&#39;jade&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">module</span><span class="o">:</span> <span class="s1">&#39;jade&#39;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/one&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">oneHandler</span> <span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/two&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">twoHandler</span> <span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<h4 id="toc_39">Request Logging</h4>

<p>In addition to the <a href="#server-logging">Server Logging</a> mechanism provided to log non-request-specific events, <strong>hapi</strong> provides
a logging interface for individual requests. By associating log events with the request responsible for them, it is easier to debug and understand
the server&#39;s behavior. It also enables batching all the request log events and deliver them to the monitor as a single package.</p>

<p>The request object is also decorated with the following methods.</p>

<ul>
<li><em>&#39;log(tags, [data, timestamp])&#39;</em> which adds a record to the request log where:

<ul>
<li><em>&#39;tags&#39;</em> - a single string or an array of strings (e.g. <em>[&#39;error&#39;, &#39;database&#39;, &#39;read&#39;]</em>) used to identify the logged event. Tags are used instead of log levels and provide a much more expressive mechanism for describing and filtering events.</li>
<li><em>&#39;data&#39;</em> - an optional message string or object with the application data being logged.</li>
<li><em>&#39;timestamp&#39;</em> - an optional timestamp override (if not present, the server will use current time), expressed in milliseconds since 1970 (_new Date().getTime()_).</li>
</ul></li>
<li><em>&#39;getLog(tags)&#39;</em> - Returns an array of events which match the tag(s) specified.</li>
</ul>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="c1">// Create Hapi servers</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="c1">// Route handler</span>
<span class="kd">var</span> <span class="nx">testLogs</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Something failed&#39;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">getLog</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Failure!&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Set routes</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">testLogs</span> <span class="p">});</span>

<span class="c1">// Start Hapi servers</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<p>The &#39;request.log&#39; method is always available.</p>

<h3 id="toc_40">Not Found Handler</h3>

<p>Whenever a route needs to respond with a simple 404 message use the <em>&#39;notFound&#39;</em> handler.  This can be done by simply setting the route <em>&#39;handler&#39;</em> property to the string &#39;notFound&#39;.  Below is an example of a route that responds with a 404.</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/hideme&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="s1">&#39;notFound&#39;</span> <span class="p">}</span>
</code></pre>
</div>

<h3 id="toc_41">Route Authentication</h3>

<p>To override the default authentication settings for a route use the <em>&#39;auth&#39;</em> object on a routes configuration.  Below are the available options for the <em>&#39;auth&#39;</em> configuration on a route.</p>

<ul>
<li><code>mode</code> - determines if a route requires authentication.  Options are <em>none</em>, <em>optional</em>, <em>try</em>, and <em>required</em> (defaults to <em>required</em> when the server has authentication configured and <em>none</em> when it doesn&#39;t).

<ul>
<li><code>none</code> - authentication is not attempted</li>
<li><code>optional</code> - authentication is attempted when the client tries to authenticate.  If authentication fails then an error will be returned to the client.  If the client doesn&#39;t try to authenticate then the resource is served without a session being set.</li>
<li><code>try</code> - authentication is attempted when the client tries to authenticate.  If authentication fails then the reason is included on the session object but the resource is still served.</li>
<li><code>required</code> - the client must be authenticated for the resource to be served, otherwise an error is returned.</li>
</ul></li>
<li><code>strategy</code> - the authentication strategy to use, will use the default strategy if not set.</li>
<li><code>strategies</code> - an array in priority order of what authentication strategies the route supports.</li>
<li><code>scope</code> - required session scope in order to access the endpoint.</li>
<li><code>tos</code> - number that represents terms of service.  Session must have an ext equal or greater than the configured tos value.</li>
<li><code>entity</code> - the type of object that must exist on the session.  Options are <em>any</em>, <em>user</em>, and <em>app</em>.</li>
</ul>

<p>When multiple authentication strategies are configured on the server individual routes can specify which of those strategies to use in priority order.  Below is an example showing how to create a route that supports the <em>&#39;hawk&#39;</em> and <em>&#39;basic&#39;</em> strategies and where authentication is optional.</p>
<div class="highlight"><pre><code class="javascript"><span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">config</span><span class="o">:</span> <span class="p">{</span> <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span> <span class="nx">strategies</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;hawk&#39;</span><span class="p">,</span> <span class="s1">&#39;basic&#39;</span><span class="p">],</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;optional&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</code></pre>
</div>

<p>If a route doesn&#39;t specify the strategy or strategies to use then the servers <em>&#39;default&#39;</em> strategy will be used.  When a single strategy is configured on the server then it will be given the strategy name <em>&#39;default&#39;</em> and will be used by any route that supports authentication.</p>

<p>In a route handler the request object has an <em>&#39;isAuthenticated&#39;</em> property that indicates whether or not the request has been authenticated.</p>

<h3 id="toc_42">Query Validation</h3>

<p>When a request URI includes a query component (the key-value part of the URI between <em>?</em> and <em>#</em>), the query is parsed into its individual
key-value pairs (see <a href="http://nodejs.org/api/querystring.html#querystring_querystring_parse_str_sep_eq_options">Query String</a>) and stored in
&#39;request.query&#39;.</p>

<p>The route <code>config.validate.query</code> defines the query validation rules performed before the route handler is invoked. Supported values:</p>

<ul>
<li><em>&#39;true&#39;</em> or <em>&#39;{}&#39;</em> - any query parameters allowed (no validation performed).  This is the default.</li>
<li><em>&#39;false&#39;</em> - no query parameters allowed.</li>
<li>a validation rules object as described in <a href="#data-validation">Data Validation</a>.</li>
</ul>

<h3 id="toc_43">Payload Validation</h3>

<p>The route <code>config.validate.payload</code> defines the payload validation rules performed before the route handler is invoked. Supported values:</p>

<ul>
<li><em>&#39;true&#39;</em> or <em>&#39;{}&#39;</em> - any payload allowed (no validation performed). This is the default.</li>
<li><em>&#39;false&#39;</em> - no payload allowed.</li>
<li>a validation rules object as described in <a href="#data-validation">Data Validation</a>.</li>
</ul>

<h3 id="toc_44">Path Validation</h3>

<p>When a request comes in for a route that allows for path parameters the request is path parameters are parsed into request.params.</p>

<p>The route <code>config.validate.path</code> defines the path validation rules performed before the route handler is invoked. Supported values:</p>

<ul>
<li><em>&#39;true&#39;</em> or <em>&#39;{}&#39;</em> - any path parameters allowed (no validation performed).  This is the default.</li>
<li><em>&#39;false&#39;</em> - no path variables allowed.</li>
<li>a validation rules object as described in <a href="#data-validation">Data Validation</a>.</li>
</ul>

<h3 id="toc_45">Response Validation</h3>

<p>The route <code>config.response</code> defines the payload validation rules performed after the route handler is invoked. Supported values:</p>

<ul>
<li><em>&#39;null&#39;</em> - any payload allowed (no validation performed). This is the default.</li>
<li><em>&#39;false&#39;</em> or <em>&#39;{}&#39;</em> - no payload allowed.</li>
<li>an object with the following options

<ul>
<li><em>&#39;schema&#39;</em> - a validation rules object as described in <a href="#data-validation">Data Validation</a>.</li>
<li><em>&#39;sample&#39;</em> - the percentage of responses to validate.  By default 100% of responses will be validated, to turn this off set the value to 0.  To validate half of the responses set this value to 50.</li>
<li><em>&#39;failAction&#39;</em> - <em>&#39;error&#39;</em> (return 500), <em>&#39;log&#39;</em> (report error but send reply as-is), or <em>&#39;ignore&#39;</em> (send reply as-is) when a response is invalid. Defaults to <em>&#39;error&#39;</em>.</li>
</ul></li>
</ul>

<p>Response validation can only be performed on object responses and will otherwise result in an error.</p>

<h3 id="toc_46">Caching</h3>

<p>&#39;GET&#39; routes may be configured to use the built-in cache. The route cache config has the following options:</p>

<ul>
<li><code>mode</code> - determines if the route is cached on the server, client, or both. Defaults to <em>&#39;client&#39;</em>.

<ul>
<li><code>server+client</code> - Caches the route response on the server and client</li>
<li><code>client</code> - Sends the Cache-Control HTTP header on the response to support client caching</li>
<li><code>server</code> - Caches the route on the server only</li>
</ul></li>
<li><code>segment</code> - Optional segment name, used to isolate cached items within the cache partition. Defaults to &#39;#name&#39; for server helpers and the
&#39;/path&#39; fingerprint (the route path with parameters represented by a &#39;?&#39; character) for routes. Note that when using the MongoDB cache
strategy, some paths will require manual override as their name will conflict with MongoDB collection naming rules. When setting segment
names manually, helper function segments must begin with &#39;##&#39; and route segments must begin with &#39;//&#39;.</li>
<li><code>expiresIn</code> - relative expiration expressed in the number of milliseconds since the item was saved in the cache. Cannot be used together with <code>expiresAt</code>.</li>
<li><code>expiresAt</code> - time of day expressed in 24h notation using the &#39;MM:HH&#39; format, at which point all cache records for the route expire. Cannot be used together with <code>expiresIn</code>.</li>
</ul>

<p>For example, to configure a route to be cached on the client and to expire after 2 minutes the configuration would look like the following:</p>
<div class="highlight"><pre><code class="text">{
    mode: &#39;client&#39;,
    expiresIn: 120000
}
</code></pre>
</div>

<p>The server-side cache also supports these advanced options:</p>

<ul>
<li><code>staleIn</code> - number of milliseconds from the time the item was saved in the cache after which it is considered stale. Value must be less than 86400000 milliseconds (one day) if using <code>expiresAt</code> or less than the value of <code>expiresIn</code>. Used together with <code>staleTimeout</code>.</li>
<li><code>staleTimeout</code> - if a cached response is stale (but not expired), the route will call the handler to generate a new response and will wait this number of milliseconds before giving up and using the stale response. When the handler finally completes, the cache is updated with the more recent update. Value must be less than <code>expiresIn</code> if used (after adjustment for units).</li>
</ul>

<h3 id="toc_47">Prerequisites</h3>

<p>Before the handler is called, it is often necessary to perform other actions such as loading required reference data from a database. The <code>pre</code> option
allows defining such pre-handler methods. The methods are called in order, unless a <code>mode</code> is specified with value &#39;parallel&#39; in which case, all the parallel methods
are executed first, then the rest in order. The <code>pre</code> is a mixed array of functions and objects. If a function is included, it is the same as including an
object with a single <code>method</code> key. The object options are:</p>

<ul>
<li><code>method</code> - the function to call. The function signature is <em>&#39;function (request, next)&#39;</em>. <em>&#39;next([result])&#39;</em> must be called when the operation concludes. If the result is an Error, execution of other prerequisites stops and the error is handled in the same way as when an error is returned from the route handler. The method can be a string invoking a <a href="#server-helpers">server helper</a>.</li>
<li><code>assign</code> - key name to assign the result of the function to within &#39;request.pre&#39;.</li>
<li><code>mode</code> - set the calling order of the function to &#39;serial&#39; or &#39;parallel&#39;. Defaults to &#39;serial&#39;.</li>
</ul>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi servers</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">fetch1</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">next</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">fetch2</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">next</span><span class="p">(</span><span class="s1">&#39;World&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">fetch3</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">next</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">m1</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">m2</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">m3</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// Set routes</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
    <span class="nx">config</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">pre</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">fetch1</span><span class="p">,</span> <span class="nx">assign</span><span class="o">:</span> <span class="s1">&#39;m1&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;parallel&#39;</span> <span class="p">},</span>
            <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">fetch2</span><span class="p">,</span> <span class="nx">assign</span><span class="o">:</span> <span class="s1">&#39;m2&#39;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;parallel&#39;</span> <span class="p">},</span>
            <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="nx">fetch3</span><span class="p">,</span> <span class="nx">assign</span><span class="o">:</span> <span class="s1">&#39;m3&#39;</span> <span class="p">},</span>
        <span class="p">],</span>
        <span class="nx">handler</span><span class="o">:</span> <span class="nx">get</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Start Hapi servers</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<h2 id="toc_48">Data Validation</h2>

<p><strong>hapi</strong> supports a rich set of data types and validation rules which are described in detail in the <a href="http://github.com/spumko/joi"><strong>joi</strong> module documentation</a>.
For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">S</span> <span class="o">=</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nb">String</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">I</span> <span class="o">=</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nb">Number</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">rules</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">username</span><span class="o">:</span> <span class="nx">S</span><span class="p">().</span><span class="nx">required</span><span class="p">().</span><span class="nx">alphanum</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="kd">with</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span>
    <span class="nx">password</span><span class="o">:</span> <span class="nx">S</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9]{3,30}/</span><span class="p">).</span><span class="nx">without</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">),</span>
    <span class="nx">token</span><span class="o">:</span> <span class="nx">S</span><span class="p">(),</span>
    <span class="nx">birthyear</span><span class="o">:</span> <span class="nx">I</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1850</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">2012</span><span class="p">),</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nx">S</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">S</span><span class="p">().</span><span class="nx">valid</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;limited&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
<span class="p">};</span>
</code></pre>
</div>

<p>In which:</p>

<ul>
<li>&#39;username&#39; is a required alphanumeric string, 3 to 30 characters long, and must appear together with &#39;email&#39;.</li>
<li>&#39;password&#39; is an optional string matching a regular expression, and must not appear together with &#39;token&#39;.</li>
<li>&#39;token&#39; is an optional string.</li>
<li>&#39;birthyear&#39; is an optional integer between 1980 and 2012.</li>
<li>&#39;email&#39; is an optional string with valid email address.</li>
<li>&#39;type&#39; is an optional string which must be set to one of three available values.</li>
</ul>

<h2 id="toc_49">Response Errors</h2>

<p>The &#39;Hapi.Error&#39; module provides helper methods to generate error responses:</p>

<ul>
<li><em>&#39;badRequest([message])&#39;</em> - HTTP 400 (Bad Request).</li>
<li><em>&#39;unauthorized([message])&#39;</em> - HTTP 401 (Unauthorized).</li>
<li><em>&#39;forbidden([message])&#39;</em> - HTTP 403 (Not Allowed).</li>
<li><em>&#39;notFound([message])&#39;</em> - HTTP 404 (Not Found).</li>
<li><em>&#39;internal([message, data])&#39;</em> - HTTP 500 (Internal Error). The optional <em>message</em> and <em>data</em> values are not returned to the client but are logged internally.</li>
</ul>

<p>The <em>message</em> value is optional and will be returned to the client in the response unless noted otherwise. For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">onUnknownRoute</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">Hapi</span><span class="p">.</span><span class="nb">Error</span><span class="p">.</span><span class="nx">unknown</span><span class="p">(</span><span class="s1">&#39;Sorry, nobody home&#39;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Error responses are send as JSON payload with the following keys (unless an <a href="#errors">error response override</a> is configured):</p>

<ul>
<li><em>code</em> - the HTTP status code (e.g. 400).</li>
<li><em>error</em> - the HTTP status message (e.g. &#39;Bad Request&#39;).</li>
<li><em>message</em> - the returned message if provided.</li>
</ul>

<p>The complete error response including any additional data is added to the request log.</p>

<h2 id="toc_50">State Management</h2>

<h3 id="toc_51">Raw Cookies</h3>

<p>Cookies can be set directly via the response <em>&#39;state(name, value, options)&#39;</em> interface where:</p>

<ul>
<li>&#39;name&#39; - is the cookie name,</li>
<li>&#39;value&#39; - is the cookie value, and</li>
<li>&#39;options&#39; - is an optional structure with the following optional keys:

<ul>
<li><code>ttl</code> - time-to-live in milliseconds.</li>
<li><code>isSecure</code> - sets the &#39;Secure&#39; flag.</li>
<li><code>isHttpOnly</code> - sets the &#39;HttpOnly&#39; flag.</li>
<li><code>path</code> - the path scope.</li>
<li><code>domain</code> - the domain scope.</li>
<li><code>autoValue</code> - if present and the cookie was not received or explicitly set by the route handler, the cookie is automatically added to the response with the provided value. Used only when the state definition is registered via <code>server.state(name, options)</code>.</li>
<li><code>encoding</code> - encoding performs on the provided value before serialization. Options are:

<ul>
<li>&#39;none&#39; - no encoding. This is the default value. Value must be a string.</li>
<li>&#39;base64&#39; - string value is encoded using Base64.</li>
<li>&#39;base64json&#39; - object value is JSON-stringified than encoded using Base64.</li>
<li>&#39;form&#39; - object value is encoded using the <em>x-www-form-urlencoded</em> method.</li>
</ul></li>
</ul></li>
</ul>

<p>Cookie definitions can be registered with the server using the server&#39;s <em>&#39;state(name, options)&#39;</em> method, where &#39;options&#39; is the same as above.
If a cookie definition is found, the options are used for that cookie as defaults before other options specified at the time of state() invocation
are applied. In addition, the <code>encoding</code> option is used when receiving a cookie from the client to parse the cookie&#39;s value, and <code>autoSet</code></p>

<h2 id="toc_52">Server Logging</h2>

<p>Most of the server&#39;s events usually relate to a specific incoming request. However, there are sometimes event that do not have a specific request
context. <strong>hapi</strong> provides a logging mechanism for general server events:</p>

<ul>
<li><em>&#39;log(tags, [data, timestamp])&#39;</em> - emits a server log event where:

<ul>
<li><em>&#39;tags&#39;</em> - a single string or an array of strings (e.g. <em>[&#39;error&#39;, &#39;database&#39;, &#39;read&#39;]</em>) used to identify the event. Tags are used instead of log levels and provide a much more expressive mechanism for describing and filtering events.</li>
<li><em>&#39;data&#39;</em> - an optional message string or object with the application data being logged.</li>
<li><em>&#39;timestamp&#39;</em> - an optional timestamp override (if not present, the server will use current time), expressed in milliseconds since 1970 (_new Date().getTime()_).</li>
</ul></li>
</ul>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="c1">// Create server</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">();</span>

<span class="c1">// Listen to log events</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Send to console</span>
    <span class="nx">Hoek</span><span class="p">.</span><span class="nx">print</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Generate event</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">log</span><span class="p">([</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="s1">&#39;info&#39;</span><span class="p">],</span> <span class="s1">&#39;Test event&#39;</span><span class="p">);</span>
</code></pre>
</div>

<h2 id="toc_53">Request Tails</h2>

<p>It is often desirable to return a response as quickly as possible and perform additional (slower) actions afterwards (or in parallel). These
actions are called request tails. For example, a request may trigger a database update tail that should not delay letting the client know the
request has been received and will be processed shortly. However, it is still desirable to associate the tails with the request and to know
when every single request related action has completed (in other words, when the request stopped wagging).</p>

<p><strong>hapi</strong> provides a simple facility for keeping track of pending tails by providing the following request methods:</p>

<ul>
<li><em>&#39;addTail([name])&#39;</em> - registers a named tail and returns a tail function. The tail function must be retained and used to remove the tail when completed. The method is available on every event or extension hook prior to the &#39;tail&#39; event.</li>
<li><em>&#39;removeTail(tail)&#39;</em> - removes a tail to notify the server that the associated action has been completed.</li>
</ul>

<p>Alternatively, the returned tail function can be called directly without using the <em>removeTail()</em> method.</p>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>

<span class="c1">// Create Hapi servers</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="c1">// Route handler</span>
<span class="kd">var</span> <span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">tail1</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">addTail</span><span class="p">(</span><span class="s1">&#39;tail1&#39;</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">request</span><span class="p">.</span><span class="nx">removeTail</span><span class="p">(</span><span class="nx">tail1</span><span class="p">);</span>              <span class="c1">// Using removeTail() interface</span>
    <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">tail2</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">addTail</span><span class="p">(</span><span class="s1">&#39;tail2&#39;</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="nx">tail2</span><span class="p">();</span>                                <span class="c1">// Using tail function interface</span>
    <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// Set routes</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">get</span> <span class="p">});</span>

<span class="c1">// Listen to tail events</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;tail&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Wag the dog&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Start Hapi servers</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre>
</div>

<h2 id="toc_54">Request Injection</h2>

<p>Request injection is the process of simulating an HTTP request without making an actual socket request. Injection is useful for testing
or debugging purposes, but also for invoking routing logic internally without the overhead or limitations of the network stack. For example,
implementing a batch mechanism which calls multiple internal routes.</p>

<p><strong>hapi</strong> uses the <a href="https://github.com/hueniverse/shot"><strong>shot</strong></a> module for performing injections. To inject a request, use the server&#39;s
<em>&#39;inject(options, callback)&#39;</em> method in which:</p>

<ul>
<li><em>&#39;options&#39;</em> - is an object containing the request information. Available options:

<ul>
<li><code>method</code> - the request HTTP method. Required.</li>
<li><code>url</code> - the request URL (as it would appear in an incoming node request object). Required.</li>
<li><code>headers</code> - any request headers. Optional.</li>
<li><code>payload</code> - a string or Buffer containing the request payload. Optional.</li>
<li><code>session</code> - a session object containing authentication information as described in <a href="#route-handler">Route Handler</a>. The <code>session</code> option is used to bypass the default authentication validation and use a pre-authenticated session. Optional.</li>
</ul></li>
<li><em>&#39;callback&#39;</em> - a callback function with the signature <em>&#39;function (res)&#39;</em> where &#39;res&#39; is the injection response object. The response object properties include:

<ul>
<li><em>&#39;headers&#39;</em> - an array containing the headers set.</li>
<li><em>&#39;statusCode&#39;</em> - the HTTP status code.</li>
<li><em>&#39;readPayload()&#39;</em> - the payload converted to a string.</li>
<li><em>&#39;result&#39;</em> - if present, the original route handler reply object.</li>
<li><em>&#39;raw&#39;</em> - the injection request and response objects.</li>
</ul></li>
</ul>

<p><strong>This is an experimental feature and is likely to change!</strong></p>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="c1">// Handler</span>
<span class="kd">var</span> <span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// Set routes</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">get</span> <span class="p">});</span>

<span class="c1">// Injection options</span>
<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span>
<span class="p">};</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">result</span> <span class="o">||</span> <span class="nx">res</span><span class="p">.</span><span class="nx">readPayload</span><span class="p">());</span>
<span class="p">});</span>
</code></pre>
</div>

<h2 id="toc_55">Server Helpers</h2>

<p>Server helpers are functions registered with the server and can be used throughout the application. The advantage of using helpers is
that they can be configured to use the built-in cache and shared across multiple request handlers. This provides a useful method for
speeding up performance by declaring functions as common utilities with a shared cache.</p>

<p>The signature of helper functions is <em>&#39;function (arg1, arg2, ..., arg3, next)&#39;</em> where next is a function defined as <em>&#39;function (result)&#39;</em>.
&#39;result&#39; can be any value or an Error (which must be generated using the <strong>hapi</strong> Error module is the helper is used as a prerequisite method).</p>

<p>To add a helper, use the server&#39;s <em>&#39;addHelper(name, method, options)&#39;</em> method where:</p>

<ul>
<li><em>&#39;name&#39;</em> - is a unique helper name used to call the method (e.g. &#39;server.helpers.name&#39;).</li>
<li><em>&#39;method&#39;</em> - is the helper function.</li>
<li><em>&#39;options&#39;</em> - optional settings where:

<ul>
<li><code>cache</code> - cache configuration as described in <a href="#caching">Caching</a>. <code>mode</code> is not allowed.</li>
<li><code>keyGenerator</code> - the server will automatically generate a unique key if the function&#39;s arguments (with the exception of the last &#39;next&#39; argument) are all of type string, number, or boolean. However if the function uses other types of arguments, a key generation function must be provided which takes the same arguments as the function and returns a unique string (or null if no key can be generated). Note that when the keyGenerator method is invoked, the arguments list will include the next argument which must not be used in calculation of the key.</li>
</ul></li>
</ul>

<p>For example:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">next</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span> <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">expiresIn</span><span class="o">:</span> <span class="mi">2000</span><span class="p">,</span>
        <span class="nx">staleIn</span><span class="o">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="nx">staleTimeout</span><span class="o">:</span> <span class="mi">100</span>
    <span class="p">},</span>
    <span class="nx">keyGenerator</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">addHelper</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">user</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Or used as a prerequisites, by passing a string with the helper invocation using the helper name and passing parameters that are all
members of the request object (without <em>next</em>):</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">http</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/user/{id}&#39;</span><span class="p">,</span>
    <span class="nx">config</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">pre</span><span class="o">:</span> <span class="p">[</span>
            <span class="s1">&#39;user(params.id)&#39;</span>
        <span class="p">],</span>
        <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<h1 id="toc_56">Server Plugins</h1>

<p>There are several extension points for <strong>hapi</strong> plugins to use.  A plugin can be as basic as adding a route or it can extend server functionality.</p>

<h2 id="toc_57">Creating a Plugin</h2>

<p>A <strong>hapi</strong> plugin should be a module that can be installable.  Therefore, it will need a <em>&#39;package.json&#39;</em> file and a unique name.  In order to identify the version of <strong>hapi</strong> that the plugin is compatible with specify a <code>peerDependencies</code> section in the <em>&#39;package.json&#39;</em> and add an entry for hapi.  To help with the plugin creation process there is a grunt-init project called <a href="https://github.com/spumko/grunt-init-hapi-plugin">grunt-init-hapi-plugin</a> that can be installed.</p>

<h3 id="toc_58">Plugin Schema</h3>

<p>The <em>&#39;main&#39;</em> module file for the plugin must export a <code>register</code> function.  The funciton signature is <code>(pack, options, next)</code> where <code>next</code> has the signature of <code>(err)</code>.  If an error occurs when registering the plugin then call next with an <code>Error</code> object. </p>

<h3 id="toc_59">Plugin Permissions</h3>

<p>A plugin is always able to control the <em>&#39;api.[plugin name]&#39;</em> object.  However, permissions restrict access to several other server features, these are listed below:</p>

<ul>
<li><code>route</code> - determines if a plugin can add routes to a server.  Default is <em>&#39;true&#39;</em>.</li>
<li><code>state</code> - when <em>&#39;true&#39;</em> the plugin can set cookies.  Default is <em>&#39;true&#39;</em>.</li>
<li><code>helper</code> - determines if a plugin can add server helpers.  Default is <em>&#39;true&#39;</em>.</li>
<li><code>events</code> - controls access to server events.  Default is <em>&#39;true&#39;</em>.</li>
<li><code>views</code> - view manager access.  Default is <em>&#39;true&#39;</em>.</li>
<li><code>ext</code> - can add extension events.  Default is <em>&#39;false&#39;</em>.</li>
</ul>

<p>Since permissions can change between servers it is necessary to return an error when a plugin is missing a required permission.  Below is an example of returning an error when a plugin doesn&#39;t have access to add a route:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pack</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">route</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Plugin requires route permission&#39;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">};</span>
</code></pre>
</div>

<h2 id="toc_60">Installable Plugins</h2>

<h3 id="toc_61">Batch Requests</h3>

<p>There is a plugin for <strong>hapi</strong> called <a href="https://npmjs.org/package/bassmaster">bassmaster</a> that can be installed to enable a batch endpoint for combining multiple requests into a single request.  Install <strong>bassmaster</strong> by either running <code>npm install bassmaster</code> in your sites working directory or add <em>&#39;bassmaster&#39;</em> to the dependencies section of the <em>&#39;package.json&#39;</em> file and run <code>npm install</code>.</p>

<p>The following plugin options are available for <strong>bassmaster</strong></p>

<ul>
<li><code>batchEndpoint</code> - the path where batch requests will be served from.  Default is &#39;/batch&#39;.</li>
</ul>

<h3 id="toc_62">CSRF Protection</h3>

<p>In order to help mitigate CSRF threats there is a plugin for <strong>hapi</strong> called <a href="https://npmjs.org/package/crumb">crumb</a> that can be installed.  Install <strong>crumb</strong> by either running <code>npm install crumb</code> in your sites working directory or add <em>&#39;crumb&#39;</em> to the dependencies section of the <em>&#39;package.json&#39;</em> file and run <code>npm install</code>.</p>

<p>The following plugin options are available for <strong>crumb</strong></p>

<ul>
<li><code>name</code> - name of cookie to store crumb.  Default is &#39;crumb&#39;.</li>
<li><code>size</code> - number of characters to randomly generate for crumb value.  Default is &#39;43&#39;. </li>
<li><code>autoGenerate</code> - bool value to indicate if the crumb should be created automatically.  Default is &#39;true&#39;.</li>
<li><code>addToViewContext</code> - bool value to indicate if crumb is added to the context of a view before the context is bound (making it accessible in a template).  Default is &#39;true&#39;.</li>
<li><code>cookieOptions</code>

<ul>
<li><code>path</code> - cookie path to restrict access to crumb cookie.  Default is &#39;/&#39;.</li>
</ul></li>
</ul>

<h3 id="toc_63">Documentation Generator</h3>

<p><strong>This is an experimental feature and is likely to change!</strong></p>

<p>In order to make it easy to generate documentation for the routes you add to <strong>hapi</strong>, a documentation generator named <strong>lout</strong> can be installed and enabled as a plugin. Install <strong>lout</strong> by either running <code>npm install lout</code> in your sites working directory or add <em>&#39;lout&#39;</em> to the dependencies section of the <em>&#39;package.json&#39;</em> file and run <code>npm install</code>.</p>

<p>The following options can be passed into <strong>lout</strong> when adding it to a server</p>

<ul>
<li><code>indexTemplatePath</code> - the file path where the index template file is located.  Default is &#39;lib/templates/index.html&#39; inside the lout module.</li>
<li><code>indexTemplate</code> - the raw source of a index template to use.  If <code>indexTemplate</code> is provided then it will be used over the file located at <code>indexTemplatePath</code>.</li>
<li><code>routeTemplatePath</code> - the file path where the routes template file is located.  Default is &#39;lib/templates/route.html&#39; inside the lout module.</li>
<li><code>routeTemplate</code> - the raw source of a route template to use.  If <code>routeTemplate</code> is provided then it will be used over the file located at <code>routeTemplatePath</code>.</li>
<li><code>templateParams</code> - an optional object of any extra information you want to pass into your template, this will be located in the templateParams object in the template data object.</li>
</ul>

<p>The simplest example of enabling <strong>lout</strong> on a site is shown in the following example:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// Create Hapi server</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">loutConfig</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">plugin</span><span class="o">:</span> <span class="p">{</span> <span class="nx">indexTemplatePath</span><span class="o">:</span> <span class="s1">&#39;./templates&#39;</span> <span class="p">}</span> <span class="p">};</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">plugin</span><span class="p">().</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lout&#39;</span><span class="p">,</span> <span class="nx">loutConfig</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="nx">http</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
</div>

<h1 id="toc_64">The End</h1>

<p>hapi hapi, joi joi</p>
</div></div>
    </div>

    <footer class="copyright">
        <p>Copyright © Walmart Labs 2013</p>
    </footer>
</section>

<script type="text/javascript" src="//use.typekit.net/vjn6umd.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

</body>
</html>