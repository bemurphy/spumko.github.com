<!DOCTYPE html>
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>hapi - Tutorials</title>

    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/overrides.css">

    <script src="/js/vendor/html5shiv.js"></script>
</head>
<body>

<header class="header" role="banner">
    <div class="l-constrained">
        <h1 class="logo logo-small">
            <a title="Return to Home" href="/">
                <img width="150" height="104" src="/img/logo-small.png" alt="hapi">
            </a>
        </h1>
    </div>
</header>

<section role="main">
    <div class="l-constrained">
        <div class="l-row"><div class="l-col1 sidebar"><ul>
<li>
<a href="#toc_0">Plugins</a>
<ul>
<li>
<a href="#toc_1">Prerequisites</a>
</li>
<li>
<a href="#toc_2">Creating an API</a>
</li>
<li>
<a href="#toc_3">Routing</a>
</li>
<li>
<a href="#toc_4">Plugging into a Subset of Servers</a>
</li>
</ul>
</li>
</ul>
</div><div class="l-col2"><h2 id="toc_0">Plugins</h2>

<h3 id="toc_1">Prerequisites</h3>

<ol>
<li>Hapi version 0.15.x or greater is installed</li>
<li>A folder with a package.json and main entry point file exist (index.js)</li>
</ol>

<p>Please read the reference guide for an overview of creating the <a href="docs/Reference.md#creating-a-plugin">plugin structure</a>.</p>

<h3 id="toc_2">Creating an API</h3>

<p>A plugin always has the ability to add properties and methods to the <em>&#39;api&#39;</em> object.  This object is useful for exposing any functionality publically.  This tutorial will demonstrate how to add a function and property to this object.</p>

<p>Export a register function that looks like the following:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pack</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">pack</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span><span class="p">;</span>
    <span class="nx">pack</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">world</span> <span class="o">=</span> <span class="s1">&#39;World&#39;</span><span class="p">;</span>
    <span class="nx">pack</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">sayHello</span> <span class="o">=</span> <span class="nx">sayHello</span><span class="p">;</span>

    <span class="nx">next</span><span class="p">();</span>
<span class="p">};</span>


<span class="kd">function</span> <span class="nx">sayHello</span> <span class="p">()</span> <span class="p">{</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hello</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">world</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In the above the <em>&#39;sayHello&#39;</em> is called with the plugin api as the context.  Therefore, it is possible to refer to the plugin api properties using <em>&#39;this&#39;</em>.  The <em>&#39;sayHello&#39;</em> function and the other properties are also accessible under the <em>&#39;server.plugins[&quot;plugin name&quot;]&#39;</em> object, where &quot;plugin name&quot; is the name of the installed plugin to access.  Below is an example of requiring the previous plugin and executing the <em>&#39;sayHello&#39;</em> function.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hapi&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;api-plugin&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

            <span class="nx">server</span><span class="p">.</span><span class="nx">plugins</span><span class="p">[</span><span class="s1">&#39;api-plugin&#39;</span><span class="p">].</span><span class="nx">sayHello</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>After the plugin is successfully required the server is started and then the plugin api method is invoked, outputting &#39;Hello World&#39; to the console.</p>

<h3 id="toc_3">Routing</h3>

<p>When a pack allows the <em>&#39;route&#39;</em> permission then any plugin within the pack can add routes to the server.  In the plugin module export a <em>&#39;register&#39;</em> function with the following signature:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pack</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
</code></pre>
</div>

<p>Next call <em>&#39;route&#39;</em> and then call <em>&#39;next&#39;</em>.</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">pack</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Hello Plugins&#39;</span><span class="p">);</span>
<span class="p">}});</span>
<span class="nx">next</span><span class="p">();</span>
</code></pre>
</div>

<p>In the event that a pack doesn&#39;t grant the <em>&#39;route&#39;</em> permission an exception will be thrown.  Therefore, there isn&#39;t a need to check first for this function unless the plugin will work without it.</p>

<p>Below is what the final plugin looks like:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pack</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">pack</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Hello Plugins&#39;</span><span class="p">);</span>
  <span class="p">}});</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">};</span>
</code></pre>
</div>

<h3 id="toc_4">Plugging into a Subset of Servers</h3>

<p>The <em>&#39;register&#39;</em> method for a plugin is passed a <em>&#39;pack&#39;</em> object.  This object has a <em>&#39;select&#39;</em> method that returns a pack of servers that match the provided criteria.  In the following, all of the servers that support TLS will be selected and a route will be added to them.</p>

<p>Begin by exporting the <em>&#39;register&#39;</em> function within the module.</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pack</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
</code></pre>
</div>

<p>Now call the <em>&#39;select&#39;</em> method on <em>&#39;pack&#39;</em> and look for the pack of servers that have the &#39;secure&#39; label.</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">securePack</span> <span class="o">=</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">select</span><span class="p">({</span> <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;secure&#39;</span> <span class="p">});</span>
</code></pre>
</div>

<p>The result of calling <em>&#39;select&#39;</em> will be a subset package of any server that match the criteria.  The result will have the same methods that existed on the original <em>&#39;pack&#39;</em> object passed in.</p>

<p>Before calling any of the methods on <em>&#39;securePack&#39;</em> check to make sure that any servers were found that meet the criteria by checking <em>&#39;length&#39;</em>.</p>
<div class="highlight"><pre><code class="javascript"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">securePack</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No secure servers found&#39;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Finally add a route that is now guranteed to be applied to only servers that support TLS.</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">securePack</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Hello Secure Server&#39;</span><span class="p">);</span>
<span class="p">}});</span>
</code></pre>
</div>

<p>The complete plugin <em>&#39;register&#39;</em> function is shown below, including the call of <em>&#39;next&#39;</em>.</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pack</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">securePack</span> <span class="o">=</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">select</span><span class="p">({</span> <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;secure&#39;</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">securePack</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No secure servers found&#39;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nx">securePack</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">request</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="s1">&#39;Hello Secure Server&#39;</span><span class="p">);</span>
    <span class="p">}});</span>

    <span class="nx">next</span><span class="p">();</span>
<span class="p">};</span>
</code></pre>
</div>
</div></div>
    </div>

    <footer class="copyright">
        <p>Copyright © Walmart Labs 2013</p>
    </footer>
</section>

<script type="text/javascript" src="//use.typekit.net/vjn6umd.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

</body>
</html>